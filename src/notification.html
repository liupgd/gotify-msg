<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notification-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            min-height: 24px;
        }

        .notification-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .countdown {
            font-size: 11px;
            opacity: 0.8;
            margin-left: 10px;
            white-space: nowrap;
        }

        .notification-message {
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
            margin-bottom: 12px;
            word-wrap: break-word;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .notification-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            min-height: 32px;
        }

        button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transition: background 0.2s;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        button:active {
            background: rgba(255, 255, 255, 0.15);
        }

        .priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        }

        .priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
        }

        .priority-low {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
    </style>
</head>
<body>
    <div class="notification-container">
        <div class="notification-header">
            <div class="notification-title" id="title">通知</div>
            <div class="countdown" id="countdown"></div>
        </div>
        <div class="notification-message" id="message"></div>
        <div class="notification-footer">
            <button id="okBtn">确定</button>
        </div>
    </div>
    
    <script>
        // 从 URL 参数获取数据
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                title: decodeURIComponent(params.get('title') || '通知'),
                message: decodeURIComponent(params.get('message') || ''),
                priority: parseInt(params.get('priority') || '0'),
                timeout: parseInt(params.get('timeout') || '5')
            };
        }

        // 初始化通知
        function initNotification() {
            console.log('初始化通知窗口...');
            
            const data = getUrlParams();
            console.log('从 URL 获取的数据:', data);
            
            // 设置标题和消息
            document.getElementById('title').textContent = data.title;
            document.getElementById('message').textContent = data.message;
            
            // 根据优先级设置背景
            const body = document.body;
            body.className = '';
            if (data.priority >= 7) {
                body.classList.add('priority-high');
            } else if (data.priority >= 4) {
                body.classList.add('priority-medium');
            } else {
                body.classList.add('priority-low');
            }
            
            // 播放提示音
            playNotificationSound();
            
            // 启动倒计时
            startCountdown(data.timeout);
            
            // 绑定确定按钮（播放音频 + 关闭窗口）
            document.getElementById('okBtn').addEventListener('click', () => {
                // 用户点击时再次尝试播放（绕开自动播放限制）
                playNotificationSound();
                closeWindow();
            });
        }

        // 播放提示音
        function playNotificationSound() {
            try {
                console.log('尝试播放提示音...');
                console.log('当前页面 URL:', window.location.href);
                
                // 获取音频文件的绝对路径
                const audioPath = new URL('notification.wav', window.location.href).href;
                console.log('音频文件路径:', audioPath);
                
                // 创建音频元素并添加到 DOM（某些浏览器需要）
                const audio = document.createElement('audio');
                audio.src = audioPath;
                audio.volume = 0.5;
                audio.preload = 'auto';
                
                // 监听加载事件
                audio.addEventListener('canplaythrough', () => {
                    console.log('音频已加载，开始播放...');
                    const playPromise = audio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            console.log('✓ 提示音播放成功');
                        }).catch(err => {
                            console.log('提示音播放失败:', err.name, err.message);
                            // 如果是自动播放策略问题，尝试静音后播放
                            if (err.name === 'NotAllowedError') {
                                console.log('尝试静音播放...');
                                audio.muted = true;
                                audio.play().then(() => {
                                    audio.muted = false;
                                    console.log('✓ 静音后播放成功');
                                }).catch(e => console.log('静音播放也失败:', e));
                            }
                        });
                    }
                }, { once: true });
                
                audio.addEventListener('error', (e) => {
                    console.error('音频加载失败:', e);
                    console.error('音频 src:', audio.src);
                    console.error('错误代码:', audio.error ? audio.error.code : 'unknown');
                    console.error('错误信息:', audio.error ? audio.error.message : 'unknown');
                });
                
                // 将音频元素添加到 DOM（隐藏）
                audio.style.display = 'none';
                document.body.appendChild(audio);
                
                // 强制加载
                console.log('开始加载音频...');
                audio.load();
                
            } catch (error) {
                console.error('创建音频对象失败:', error);
            }
        }

        let countdownInterval = null;
        let timeoutId = null;

        function startCountdown(seconds) {
            const countdownEl = document.getElementById('countdown');
            let remaining = seconds;
            
            // 清除之前的定时器
            clearTimers();
            
            // 更新倒计时显示
            function updateDisplay() {
                countdownEl.textContent = remaining + '秒后关闭';
            }
            
            updateDisplay();
            
            // 每秒更新
            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearTimers();
                    closeWindow();
                } else {
                    updateDisplay();
                }
            }, 1000);
            
            // 设置自动关闭
            timeoutId = setTimeout(() => {
                closeWindow();
            }, seconds * 1000);
        }

        function clearTimers() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
        }

        async function closeWindow() {
            console.log('关闭窗口...');
            clearTimers();
            
            try {
                // 尝试使用 Tauri API 关闭窗口
                if (window.__TAURI__) {
                    // Tauri v2 使用 getCurrentWindow()
                    const { getCurrentWindow } = window.__TAURI__.window;
                    if (getCurrentWindow) {
                        const win = getCurrentWindow();
                        if (win?.close) {
                            await win.close();
                            console.log('✓ 窗口已关闭 (Tauri API)');
                            return;
                        }
                    }
                }
                
                // 如果 Tauri API 不可用，尝试使用 window.close()
                window.close();
                console.log('✓ 窗口已关闭 (window.close)');
            } catch (error) {
                console.error('关闭窗口失败:', error);
                // 最后的备用方案
                try {
                    window.close();
                } catch (e) {
                    console.error('window.close 也失败了:', e);
                }
            }
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNotification);
        } else {
            initNotification();
        }
    </script>
</body>
</html>
