<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>通知</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .notification-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            min-height: 24px;
        }

        .notification-title {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .countdown {
            font-size: 11px;
            opacity: 0.8;
            margin-left: 10px;
            white-space: nowrap;
        }

        .notification-message {
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
            margin-bottom: 12px;
            word-wrap: break-word;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .notification-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            min-height: 32px;
        }

        button {
            padding: 6px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.25);
            color: white;
            transition: background 0.2s;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        button:active {
            background: rgba(255, 255, 255, 0.15);
        }

        .priority-high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        }

        .priority-medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
        }

        .priority-low {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
    </style>
</head>
<body>
    <div class="notification-container">
        <div class="notification-header">
            <div class="notification-title" id="title">通知</div>
            <div class="countdown" id="countdown"></div>
        </div>
        <div class="notification-message" id="message"></div>
        <div class="notification-footer">
            <button id="okBtn">确定</button>
        </div>
    </div>
    
    <script>
        // 从 URL 参数获取数据
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                title: decodeURIComponent(params.get('title') || '通知'),
                message: decodeURIComponent(params.get('message') || ''),
                priority: parseInt(params.get('priority') || '0'),
                timeout: parseInt(params.get('timeout') || '5')
            };
        }

        // 初始化通知
        function initNotification() {
            console.log('初始化通知窗口...');
            
            const data = getUrlParams();
            console.log('从 URL 获取的数据:', data);
            
            // 设置标题和消息
            document.getElementById('title').textContent = data.title;
            document.getElementById('message').textContent = data.message;
            
            // 根据优先级设置背景
            const body = document.body;
            body.className = '';
            if (data.priority >= 7) {
                body.classList.add('priority-high');
            } else if (data.priority >= 4) {
                body.classList.add('priority-medium');
            } else {
                body.classList.add('priority-low');
            }
            
            // 播放提示音
            playNotificationSound();
            
            // 启动倒计时
            startCountdown(data.timeout);
            
            // 绑定确定按钮（播放音频 + 关闭窗口）
            document.getElementById('okBtn').addEventListener('click', () => {
                // 用户点击时再次尝试播放（绕开自动播放限制）
                playNotificationSound();
                closeWindow();
            });
        }

        // 使用 Web Audio API 生成提示音（不依赖外部文件）
        function playNotificationSound() {
            try {
                console.log('尝试播放提示音...');
                
                // 创建音频上下文
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) {
                    console.error('浏览器不支持 Web Audio API');
                    return;
                }
                
                const ctx = new AudioContext();
                
                // 创建振荡器（双音调提示音）
                const oscillator1 = ctx.createOscillator();
                const oscillator2 = ctx.createOscillator();
                const gainNode = ctx.createGain();
                
                // 设置第一个音调（高频）
                oscillator1.type = 'sine';
                oscillator1.frequency.setValueAtTime(880, ctx.currentTime); // A5
                oscillator1.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.1);
                
                // 设置第二个音调（低频，形成和声）
                oscillator2.type = 'sine';
                oscillator2.frequency.setValueAtTime(698.46, ctx.currentTime); // F5
                oscillator2.frequency.exponentialRampToValueAtTime(349.23, ctx.currentTime + 0.1);
                
                // 设置音量包络
                gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                
                // 连接音频节点
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // 播放
                oscillator1.start(ctx.currentTime);
                oscillator2.start(ctx.currentTime);
                oscillator1.stop(ctx.currentTime + 0.5);
                oscillator2.stop(ctx.currentTime + 0.5);
                
                console.log('✓ 提示音播放成功');
                
            } catch (error) {
                console.error('播放提示音失败:', error);
            }
        }

        let countdownInterval = null;
        let timeoutId = null;

        function startCountdown(seconds) {
            const countdownEl = document.getElementById('countdown');
            let remaining = seconds;
            
            // 清除之前的定时器
            clearTimers();
            
            // 更新倒计时显示
            function updateDisplay() {
                countdownEl.textContent = remaining + '秒后关闭';
            }
            
            updateDisplay();
            
            // 每秒更新
            countdownInterval = setInterval(() => {
                remaining--;
                if (remaining <= 0) {
                    clearTimers();
                    closeWindow();
                } else {
                    updateDisplay();
                }
            }, 1000);
            
            // 设置自动关闭
            timeoutId = setTimeout(() => {
                closeWindow();
            }, seconds * 1000);
        }

        function clearTimers() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            if (timeoutId) {
                clearTimeout(timeoutId);
                timeoutId = null;
            }
        }

        async function closeWindow() {
            console.log('关闭窗口...');
            clearTimers();
            
            try {
                // 尝试使用 Tauri API 关闭窗口
                if (window.__TAURI__) {
                    // Tauri v2 使用 getCurrentWindow()
                    const { getCurrentWindow } = window.__TAURI__.window;
                    if (getCurrentWindow) {
                        const win = getCurrentWindow();
                        if (win?.close) {
                            await win.close();
                            console.log('✓ 窗口已关闭 (Tauri API)');
                            return;
                        }
                    }
                }
                
                // 如果 Tauri API 不可用，尝试使用 window.close()
                window.close();
                console.log('✓ 窗口已关闭 (window.close)');
            } catch (error) {
                console.error('关闭窗口失败:', error);
                // 最后的备用方案
                try {
                    window.close();
                } catch (e) {
                    console.error('window.close 也失败了:', e);
                }
            }
        }
        
        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNotification);
        } else {
            initNotification();
        }
    </script>
</body>
</html>
